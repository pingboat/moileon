<div class="quiz-section" style="text-align: center;">
    <h1 class="quiz-title">Quest On!</h1>
    <div class="score">Score: <span id="score-display">0</span></div>
    <div class="question" id="question-display">Loading question...</div>
    
    <input type="text" class="answer-input" id="answer-input" placeholder="Type your answer here">
    <div class="instruction">Press Enter after typing your answer</div>
    
    <div class="quiz-buttons">
        <button class="button submit-btn">Submit Answer</button>
        <button class="button next-btn">Show me the answer</button>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    // Load quiz questions from Hugo data file
    const questions = {{ .Site.Data.questions.questions | jsonify }};

    // TEMPORARY DEBUG - Remove after testing
    alert("Total questions loaded: " + questions.length);
    if (questions.length > 0) {
        alert("First question: " + questions[0].question.substring(0, 50) + "...");
        alert("First answer type: " + typeof questions[0].correct_answer);
        if (Array.isArray(questions[0].correct_answer)) {
            alert("Answer is array with " + questions[0].correct_answer.length + " items");
        }
    } else {
        alert("ERROR: No questions found in the data!");
    }

    let currentQuestionIndex = 0;
    let score = 0;
    let shuffledQuestions = [];

    const questionElement = document.getElementById("question-display");
    const answerInput = document.getElementById("answer-input");
    const submitButton = document.querySelector(".submit-btn");
    const nextButton = document.querySelector(".next-btn");
    const scoreElement = document.getElementById("score-display");

    // Only initialize if all elements exist
    if (!questionElement || !answerInput || !submitButton || !scoreElement) {
        alert("ERROR: Some page elements are missing!");
        return;
    }

    // Filter active questions only
    const activeQuestions = questions.filter(q => q.active !== false);
    alert("Active questions: " + activeQuestions.length);

    // Initialize quiz
    shuffledQuestions = shuffleArray([...activeQuestions]);
    showQuestion();

    function shuffleArray(array) {
        const shuffled = [...array];
        for (let i = shuffled.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
        }
        return shuffled;
    }

    function showQuestion() {
        if (currentQuestionIndex >= shuffledQuestions.length) {
            finishQuiz();
            return;
        }

        const currentQuestion = shuffledQuestions[currentQuestionIndex];
        questionElement.textContent = currentQuestion.question;
        answerInput.value = "";
        answerInput.disabled = false;
        answerInput.focus();

        submitButton.textContent = "Submit Answer";
        submitButton.disabled = false;
        nextButton.textContent = "Show me the answer";
        nextButton.disabled = false;
    }

    function getCorrectAnswers(question) {
        // Handle both array and string formats for backward compatibility
        if (Array.isArray(question.correct_answer)) {
            return question.correct_answer;
        } else if (typeof question.correct_answer === 'string') {
            return [question.correct_answer];
        }
        // Fallback to old 'answer' field if it exists
        if (Array.isArray(question.answer)) {
            return question.answer;
        } else if (typeof question.answer === 'string') {
            return [question.answer];
        }
        return ["unknown"];
    }

    function getDisplayAnswer(question) {
        const answers = getCorrectAnswers(question);
        return answers[0];
    }

    function checkAnswer() {
        const userAnswer = answerInput.value.trim().toLowerCase();
        if (!userAnswer) return;

        const currentQuestion = shuffledQuestions[currentQuestionIndex];
        const correctAnswers = getCorrectAnswers(currentQuestion).map(ans => ans.toLowerCase());
        const isCorrect = correctAnswers.some(answer => userAnswer === answer);

        if (isCorrect) {
            score += currentQuestion.points || 10;
            scoreElement.textContent = score;
            let message = "Correct!";
            if (currentQuestion.explanation) {
                message += "\n\n" + currentQuestion.explanation;
            }
            alert(message);
        } else {
            const correctAnswer = getDisplayAnswer(currentQuestion);
            let message = "Incorrect. The correct answer is: " + correctAnswer;
            if (currentQuestion.explanation) {
                message += "\n\n" + currentQuestion.explanation;
            }
            alert(message);
        }

        answerInput.disabled = true;
        submitButton.textContent = "Next Question";
    }

    function showAnswer() {
        const currentQuestion = shuffledQuestions[currentQuestionIndex];
        const correctAnswer = getDisplayAnswer(currentQuestion);
        let message = "The answer is: " + correctAnswer;
        if (currentQuestion.explanation) {
            message += "\n\n" + currentQuestion.explanation;
        }
        alert(message);
    }

    function nextQuestion() {
        currentQuestionIndex++;
        showQuestion();
    }

    function finishQuiz() {
        questionElement.textContent = "Quiz completed!";
        const maxScore = shuffledQuestions.reduce((sum, q) => sum + (q.points || 10), 0);
        const percentage = Math.round((score / maxScore) * 100);
        let message = `Final Score: ${score}/${maxScore} (${percentage}%)`;
        
        if (percentage >= 80) message += " - Excellent!";
        else if (percentage >= 60) message += " - Good job!";
        else message += " - Keep practicing!";
        
        alert(message);
        
        submitButton.textContent = "Restart Quiz";
        nextButton.style.display = "none";
        answerInput.style.display = "none";
    }

    function restartQuiz() {
        currentQuestionIndex = 0;
        score = 0;
        scoreElement.textContent = score;
        shuffledQuestions = shuffleArray([...activeQuestions]);
        nextButton.style.display = "inline-block";
        answerInput.style.display = "block";
        showQuestion();
    }

    // Event listeners
    submitButton.addEventListener("click", function() {
        if (this.textContent === "Next Question") {
            nextQuestion();
        } else if (this.textContent === "Restart Quiz") {
            restartQuiz();
        } else {
            checkAnswer();
        }
    });

    nextButton.addEventListener("click", showAnswer);

    answerInput.addEventListener("keypress", function(event) {
        if (event.key === "Enter" && !answerInput.disabled) {
            if (submitButton.textContent === "Submit Answer") {
                checkAnswer();
            } else if (submitButton.textContent === "Next Question") {
                nextQuestion();
            }
        }
    });
});
</script>

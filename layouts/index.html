{{ define "main" }}

<div class="logo-section" style="text-align: center;">
    <div class="logo-text">ALL LIFE IS YOGA.</div>
    <div class="lotus-image">
        <img src="{{ "images/lotus.png" | relURL }}" alt="Lotus with Om Symbol">
    </div>
</div>

<div class="quiz-section" style="text-align: center;">
    <h1 class="quiz-title">Quest On!</h1>
    <div class="score">Score: <span id="score-display">0</span></div>
    <div class="question" id="question-display">Loading question...</div>
    
    <!-- Embedded quiz data for JavaScript -->
    <script id="quiz-data" type="application/json">
    {{ $quizData := getJSON "data/questions.json" }}
    {{ $quizData | jsonify }}
    </script>
    
    <input type="text" class="answer-input" id="answer-input" placeholder="Type your answer here">
    <div class="instruction">Press Enter after typing your answer</div>
    
    <div class="quiz-buttons">
        <button class="button submit-btn">Submit Answer</button>
        <button class="button next-btn">Show me the answer</button>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        let questions = [];
        let currentQuestionIndex = 0;
        let score = 0;

        const questionElement = document.getElementById("question-display");
        const answerInput = document.getElementById("answer-input");
        const submitButton = document.querySelector(".submit-btn");
        const nextButton = document.querySelector(".next-btn");
        const scoreElement = document.getElementById("score-display");

        // Check if we're on a quiz page
        if (!questionElement || !answerInput || !submitButton || !scoreElement) {
            return;
        }

        // Load quiz data from embedded script tag
        const quizDataElement = document.getElementById("quiz-data");
        if (quizDataElement) {
            try {
                questions = JSON.parse(quizDataElement.textContent);
                questions = shuffleArray(questions);
                showQuestion();
            } catch (error) {
                questionElement.textContent = "âš ï¸ Failed to load quiz questions.";
            }
        } else {
            questionElement.textContent = "âš ï¸ Quiz data not found.";
        }

        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function showQuestion() {
            if (currentQuestionIndex >= questions.length) {
                finishQuiz();
                return;
            }
            const currentQuestion = questions[currentQuestionIndex];
            questionElement.textContent = currentQuestion.question;
            answerInput.value = "";
            answerInput.disabled = false;
            answerInput.focus();
            submitButton.textContent = "Submit Answer";
            nextButton.textContent = "Show me the answer";
            nextButton.style.display = "inline-block";
        }

        function getCorrectAnswers(question) {
            if (Array.isArray(question.answer)) {
                return question.answer;
            } else if (typeof question.answer === 'string') {
                return [question.answer];
            } else {
                return ["unknown"];
            }
        }

        function checkAnswer() {
            const userAnswer = answerInput.value.trim().toLowerCase();
            if (!userAnswer) return;
            const currentQuestion = questions[currentQuestionIndex];
            const correctAnswers = getCorrectAnswers(currentQuestion).map(ans => ans.toLowerCase());
            const isCorrect = correctAnswers.some(answer => userAnswer === answer);

            if (isCorrect) {
                score++;
                scoreElement.textContent = score;
                let message = "âœ… Correct!";
                if (currentQuestion.explanation) {
                    message += "\n\nðŸ’¡ " + currentQuestion.explanation;
                }
                alert(message);
            } else {
                const correctAnswer = getCorrectAnswers(currentQuestion)[0];
                let message = "âŒ Incorrect. The correct answer is: " + correctAnswer;
                if (currentQuestion.explanation) {
                    message += "\n\nðŸ’¡ " + currentQuestion.explanation;
                }
                alert(message);
            }
            answerInput.disabled = true;
            nextButton.textContent = "Next Question"; // Change button text to advance
            submitButton.style.display = "none";
        }

        function showAnswer() {
            const currentQuestion = questions[currentQuestionIndex];
            const correctAnswer = getCorrectAnswers(currentQuestion)[0];
            let message = "ðŸ’¡ The answer is: " + correctAnswer;
            if (currentQuestion.explanation) {
                message += "\n\n" + currentQuestion.explanation;
            }
            alert(message);
            answerInput.disabled = true;
            nextButton.textContent = "Next Question"; // Change button text to advance
            submitButton.style.display = "none";
        }

        function nextQuestion() {
            currentQuestionIndex++;
            showQuestion();
            submitButton.style.display = "inline-block";
        }

        function finishQuiz() {
            questionElement.textContent = "ðŸŽ‰ Quiz completed!";
            const percentage = Math.round((score / questions.length) * 100);
            let message = `Final Score: ${score}/${questions.length} (${percentage}%)`;
            if (percentage >= 80) message += " - Excellent!";
            else if (percentage >= 60) message += " - Good job!";
            else message += " - Keep practicing!";
            alert(message);
            submitButton.textContent = "Restart Quiz";
            submitButton.style.display = "inline-block";
            nextButton.style.display = "none";
            answerInput.style.display = "none";
        }

        function restartQuiz() {
            currentQuestionIndex = 0;
            score = 0;
            scoreElement.textContent = score;
            questions = shuffleArray(questions);
            nextButton.style.display = "inline-block";
            answerInput.style.display = "block";
            showQuestion();
        }

        // Event listeners
        submitButton.addEventListener("click", function () {
            if (this.textContent === "Restart Quiz") {
                restartQuiz();
            } else {
                checkAnswer();
            }
        });

        nextButton.addEventListener("click", function () {
            if (this.textContent === "Next Question") {
                nextQuestion();
            } else {
                showAnswer();
            }
        });

        answerInput.addEventListener("keypress", function (event) {
            if (event.key === "Enter" && !answerInput.disabled) {
                checkAnswer();
            }
        });
    });
</script>


{{ end }}

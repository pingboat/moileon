<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Post | moileon</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: Georgia, serif;
            background-color: #f8f8f8;
            color: #333;
            line-height: 1.6;
        }
        .container {
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #000080;
            margin-bottom: 10px;
            font-weight: normal;
        }
        .meta {
            color: #666;
            margin-bottom: 20px;
        }
        .content p { margin: 10px 0; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
</head>
<body>
    <div class="container">
        <h1 id="post-title">Loading...</h1>
        <div id="post-meta" class="meta"></div>
        <div id="post-content" class="content">Please wait.</div>
    </div>

    <script>
        const CONTENT_BRANCH = (window.location.hostname.startsWith('dev--') || window.location.hostname.includes('localhost')) ? 'dev' : 'main';

        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const path = urlParams.get('path');
            if (!path || !/^content\/blog\/[^\n\r]+\.md$/i.test(path)) {
                renderError('Invalid post path.');
                return;
            }
            loadPost(path);
        });

        async function loadPost(path) {
            try {
                const rawUrl = `https://raw.githubusercontent.com/pingboat/moileon/${CONTENT_BRANCH}/${path}`;
                const resp = await fetch(rawUrl);
                if (!resp.ok) {
                    renderError('Post not found.');
                    return;
                }
                const text = await resp.text();
                const parsed = parseMarkdown(text);
                document.getElementById('post-title').textContent = parsed.frontMatter.title || titleFromPath(path);
                document.getElementById('post-meta').textContent = formatMeta(parsed.frontMatter);
                document.getElementById('post-content').innerHTML = renderMarkdown(parsed.content);
                document.title = `${document.getElementById('post-title').textContent} | moileon`;
            } catch (e) {
                renderError('Error loading post.');
            }
        }

        function parseMarkdown(text) {
            let frontMatter = {};
            let content = text;
            const match = text.match(/^---\s*\n([\s\S]*?)\n---\s*/);
            if (match) {
                try { frontMatter = jsyaml.load(match[1]) || {}; } catch (e) { frontMatter = {}; }
                content = text.slice(match[0].length).trim();
            }
            return { frontMatter, content };
        }

        function renderMarkdown(md) {
            return md
                .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                .replace(/\*\*(.*)\*\*/gim, '<strong>$1</strong>')
                .replace(/\*(.*)\*/gim, '<em>$1</em>')
                .replace(/\n\n/gim, '</p><p>')
                .replace(/\n/gim, '<br>');
        }

        function titleFromPath(path) {
            const base = path.split('/').pop() || '';
            return base.replace(/\.md$/i, '');
        }

        function formatMeta(fm) {
            const parts = [];
            if (fm.date) {
                try {
                    parts.push(new Date(fm.date).toLocaleDateString());
                } catch (e) {}
            }
            if (fm.author) {
                parts.push(`By ${fm.author}`);
            }
            return parts.join(' Â· ');
        }

        function renderError(msg) {
            document.getElementById('post-title').textContent = 'Error';
            document.getElementById('post-meta').textContent = '';
            document.getElementById('post-content').textContent = msg;
        }
    </script>
</body>
</html>